<!DOCTYPE html>


const acciones = Array.isArray(f["Plan de acción propuesto"]) ? f["Plan de acción propuesto"]
: f["Plan de acción propuesto"] ? segmentParagraphs(String(f["Plan de acción propuesto"]))
: Array.isArray(f["Acciones tomadas"]) ? f["Acciones tomadas"]
: f["Acciones tomadas"] ? segmentParagraphs(String(f["Acciones tomadas"]))
: [];


let updates = [];
const updRaw = f["Notas de actualización"] ?? f["Notas"];
if (Array.isArray(updRaw)) { updates = updRaw.flatMap(t => segmentParagraphs(String(t)).map(p => ({ texto: p, fecha: "" }))); }
else if (updRaw) { updates = segmentParagraphs(String(updRaw)).map(p => ({ texto: p, fecha: "" })); }


const cierreRaw = f["Fecha estimada de cierre (vigente)"] ?? f["Fecha estimada de cierre"] ?? f["Fecha Estimada de Cierre"] ?? "";
const cierre = (cierreRaw && typeof cierreRaw === "object") ? (cierreRaw.start || cierreRaw.date || "") : cierreRaw;


const cierreRealRaw = f["Fecha real de cierre"] ?? f["Fecha Real de Cierre"] ?? f["Fecha de cierre real"] ?? f["Fecha de cierre efectiva"] ?? f["Fecha de Cierre Efectiva"] ?? f["Fecha de cierre"] ?? f["Fecha de Cierre"] ?? "";
const cierreEfectivo = (cierreRealRaw && typeof cierreRealRaw === "object") ? (cierreRealRaw.start || cierreRealRaw.date || "") : cierreRealRaw;


const responsablePrincipal = f["Responsable"] || f["Responsable principal"] || (Array.isArray(f["Responsable (lookup)"]) ? f["Responsable (lookup)"][0] : f["Responsable (lookup)"]) || "";
const responsableSeg = f["Responsable del seguimiento"] || f["Responsable seguimiento"] || (Array.isArray(f["Responsable de seguimiento (lookup)"]) ? f["Responsable de seguimiento (lookup)"][0] : f["Responsable de seguimiento (lookup)"]) || "";


const descripcion = f["Descripción del Suceso"] || f["Descripción del suceso"] || f["Descripcion del Suceso"] || f["Descripción"] || f["Descripcion"] || "";
const estacion = f["Estación"] || f["Estación/Área"] || "";


// ===== Attachments =====
const pruebas = Array.isArray(f["Pruebas de cierre"]) ? f["Pruebas de cierre"].map(a => ({ url: a.url || a?.thumbnails?.large?.url || a?.thumbnails?.full?.url || "", filename: a.filename || "Prueba de cierre", type: a.type || '' })).filter(x => x.url) : [];


const evidencias = Array.isArray(f["Evidencias"]) ? f["Evidencias"].map(a => ({ url: a.url || a?.thumbnails?.large?.url || a?.thumbnails?.full?.url || "", filename: a.filename || "Evidencia", type: a.type || '' })).filter(x => x.url) : [];


return {
id: f["ID del reporte"] || id,
fecha: f["Fecha de Evento"] || f["Fecha"] || "",
cierre,
cierreEfectivo,
estado: f["Estado del reporte"] || f["Estado"] || "—",
responsablePrincipal,
responsable: responsableSeg,
estacion,
descripcion,
acciones,
updates,
pruebas,
evidencias
};
}


window.addEventListener('DOMContentLoaded', ()=>{
const form = document.getElementById('searchForm');
const input = document.getElementById('reportId');
const btn = document.getElementById('btnBuscar');


form.addEventListener('submit', async (e)=>{
e.preventDefault();
const id = (input.value || '').trim().toUpperCase();
if(!id){ ui.show('Por favor escribe el <strong>ID del reporte</strong>.'); return; }
if(!ID_REGEX.test(id)){
ui.show('Formato de ID no válido. Usa <strong>IATA-DDMMYYYYHHmm</strong> (ej.: <code>SDQ-260120251031</code>).');
return;
}


const old = btn.textContent;
btn.textContent = 'Buscando…'; btn.disabled = true;
ui.show('Buscando reporte…');


try{ const data = await fetchReport(id); if (data) renderReport(data); }
catch(err){ ui.show(`❌ Error inesperado.<br><small>${err.message}</small>`); }
finally{ btn.textContent = old; btn.disabled = false; }
});
});
})();
</script>
</body>
</html>
