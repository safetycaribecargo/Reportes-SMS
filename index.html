<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Caribe Cargo · Portal Interno</title>

  <style>
    :root{
      --blue-dark:#002D72;
      --blue:#00439b;
      --blue-light:#00AEEF;
      --bg:#ffffff;
      --card:#f5f7fa;
      --text:#111827;
      --muted:#374151;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 30px rgba(0,0,0,.15);
      --radius:18px;
      --logo-h:32px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --card:#0f172a;
        --text:#E5E7EB;
        --muted:#94A3B8;
        --border:rgba(255,255,255,.10);
        --shadow:0 10px 30px rgba(0,0,0,.45);
      }
    }
    body{margin:0;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 600px at 120% -20%, rgba(0,174,239,.18), transparent 60%),linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);min-height:100dvh;}
    header{position:sticky;top:0;z-index:5;background:var(--blue-dark);color:#fff;border-bottom:1px solid var(--blue);}
    .nav{max-width:1100px;margin:0 auto;padding:16px 20px;display:flex;align-items:center;justify-content:space-between}
    .brand{display:flex;gap:12px;align-items:center;font-weight:800;letter-spacing:.06em;color:#fff}
    .brand .logo{height:var(--logo-h);width:auto;object-fit:contain}
    .brand .word{text-transform:uppercase;font-size:clamp(16px,2.2vw,22px)}
    .menu span{color:#fff}
    .container{max-width:1100px;margin:0 auto;padding:40px 20px 70px}
    .search-card{width:min(880px,100%);margin:24px auto;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px;border:1px solid var(--border)}
    .search-row{display:flex;gap:12px;flex-wrap:wrap}
    .search-row input{flex:1;padding:16px;border-radius:12px;border:1px solid var(--border);font-size:16px;background:transparent;color:var(--text)}
    .btn{border:none;background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;padding:14px 18px;border-radius:12px;font-weight:700;cursor:pointer;min-width:130px}
    .result{display:none;margin:26px auto 0;width:min(100%,1100px)}
    .result.active{display:block}
    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
    .card .hd{padding:14px 18px;border-bottom:1px solid var(--border);font-weight:800;color:#cde4ff}
    .card .bd{padding:18px}
    .grid{display:grid;gap:16px;grid-template-columns:1.2fr 1fr;margin-top:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .report-header{display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(135deg,var(--blue-dark),var(--blue));color:#fff;padding:18px 22px;border-radius:16px;box-shadow:var(--shadow)}
    .chip{padding:8px 12px;border-radius:999px;font-weight:700;border:1px solid rgba(255,255,255,.35)}
    .badge{background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.35);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;color:#fff}
    .chip--cerrado{background:#16a34a;color:#fff;border:1px solid #16a34a}
    .chip--en-proceso{background:#f59e0b;color:#111827;border:1px solid #f59e0b}
    .chip--no-iniciado{background:#dc2626;color:#fff;border:1px solid #dc2626}
    .list{display:grid;grid-template-columns:1fr 1fr;gap:10px 18px}
    .list .k{color:var(--muted);font-size:13px}
    .list .v{font-weight:600}
    .plan-accion,.timeline{list-style:disc;padding-left:20px;margin:0}
    .plan-accion li,.timeline li{margin-bottom:12px;line-height:1.6}
    .plan-accion li::marker,.timeline li::marker{color:var(--blue-light)}
    .galeria{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .galeria img,.galeria video{width:100%;height:150px;object-fit:cover;border-radius:8px;background:#000}
    .empty{color:var(--muted);font-style:italic}
    footer{text-align:center;color:var(--muted);padding:28px}
  </style>
</head>

<body>
  <header>
    <nav class="nav">
      <div class="brand"><img src="assets/logo.png" class="logo"/><span class="word">CARIBE CARGO</span></div>
      <div class="menu"><span>Portal Interno</span></div>
    </nav>
  </header>

  <section class="hero">
    <div class="container">
      <div class="search-card">
        <form id="searchForm" autocomplete="off">
          <div class="search-row">
            <input id="reportId" placeholder="Ej.: SDQ-260120251031"/>
            <button class="btn" id="btnBuscar" type="submit">Buscar</button>
          </div>
          <small style="color:var(--muted)">Formato: IATA-DDMMYYYYHHmm</small>
        </form>
      </div>
      <div id="result" class="result"></div>
    </div>
  </section>

  <footer>© Caribe Cargo · Uso interno</footer>

  <script>
  (()=>{

    const FN_URL='/.netlify/functions/airtable';
    const ID_REGEX=/^[A-Z]{3}-\d{12}$/;
    const $=s=>document.querySelector(s);
    const ui={show(h){const r=$('#result');r.innerHTML=`<div class="search-card" style="text-align:center">${h}</div>`;r.classList.add('active')}};

    const formatDate=(iso)=>{
      if(!iso)return"";const d=new Date(iso);
      if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){const [y,m,day]=iso.split("-").map(Number);const local=new Date(y,m-1,day);return local.toLocaleDateString("es-DO",{day:"2-digit",month:"long",year:"numeric"});}
      return isNaN(d)?iso:d.toLocaleDateString("es-DO",{day:"2-digit",month:"long",year:"numeric"});
    };

    const STATUS_MAP=[
      {match:/cerrad/,cls:'chip--cerrado',label:'Cerrado'},
      {match:/(no[\s-]?iniciado)/,cls:'chip--no-iniciado',label:'No iniciado'},
      {match:/iniciado/,cls:'chip--iniciado',label:'Iniciado'},
      {match:/(en[\s-]?proceso)/,cls:'chip--en-proceso',label:'En proceso'}
    ];
    const normalize=x=>(x||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    const statusClass=e=>{const s=normalize(e);for(const r of STATUS_MAP)if(r.match.test(s))return r.cls;return'';}
    const statusLabel=e=>{const s=normalize(e);for(const r of STATUS_MAP)if(r.match.test(s))return r.label;return e||'—';}
    const segmentParagraphs=t=>{if(!t)return[];let x=String(t).replace(/\r\n/g,"\n").trim();let p=x.split(/\n{2,}/).map(s=>s.trim()).filter(Boolean);if(p.length>1)return p;x=x.replace(/(^|\n)\s*(\d+)\.\s+/g,(m,pre,n)=>`${pre}§§§${n}. `);p=x.split(/§§§(?=\d+\.\s*)/).map(s=>s.trim()).filter(Boolean);return p.length>1?p:x.split(/\n+/).map(s=>s.trim()).filter(Boolean);};

    function renderReport(r){
      const el=$('#result');
      if(!r){ui.show("No se encontró ningún reporte con ese ID.");return;}
      const acciones=(r.acciones||[]).map(a=>`<li>${a}</li>`).join('')||'<em>—</em>';
      const updates=(r.updates||[]).map(u=>`<li>${u.texto}</li>`).join('')||'<li><em>Sin actualizaciones</em></li>';
      const statusCls=statusClass(r.estado),statusTxt=statusLabel(r.estado);
      const fechaCierre=r.cierreEfectivo||r.cierre;
      const badge=/cerrad/i.test(r.estado||'')?`<span class="badge">Cerrado: ${formatDate(fechaCierre)}</span>`:"";

      // --- Evidencias ---
      let evidenciasHTML='';
      if(Array.isArray(r.evidencias)&&r.evidencias.length){
        const gal=r.evidencias.map(m=>{
          const t=(m.type||'').toLowerCase();
          const isVideo=t.startsWith('video')||/\.(mp4|webm|mov)$/i.test(m.filename||'');
          return isVideo?`<video src="${m.url}" controls title="${m.filename}"></video>`:`<img src="${m.url}" alt="${m.filename}">`;
        }).join('');
        evidenciasHTML=`<div class="card" style="margin-top:16px"><div class="hd">Evidencias</div><div class="bd"><div class="galeria">${gal}</div></div></div>`;
      }else{
        evidenciasHTML=`<div class="card" style="margin-top:16px"><div class="hd">Evidencias</div><div class="bd"><p class="empty">No se subieron evidencias para este reporte.</p></div></div>`;
      }

      // --- Pruebas de cierre ---
      let pruebasHTML='';
      if(/cerrad/i.test(r.estado||'')&&Array.isArray(r.pruebas)&&r.pruebas.length){
        const imgs=r.pruebas.map(p=>`<img src="${p.url}" alt="${p.filename}">`).join('');
        pruebasHTML=`<div class="card" style="margin-top:16px"><div class="hd">Pruebas de cierre</div><div class="bd"><div class="galeria">${imgs}</div></div></div>`;
      }

      el.innerHTML=`
      <div class="report-header"><div>Reporte <strong>${r.id}</strong></div><div class="chip-row"><div class="chip ${statusCls}">${statusTxt}</div>${badge}</div></div>
      <div class="grid">
        <section class="card"><div class="hd">Datos del reporte</div><div class="bd">
          <div class="list">
            <div class="k">ID</div><div class="v">${r.id}</div>
            <div class="k">Fecha</div><div class="v">${formatDate(r.fecha)}</div>
            <div class="k">Fecha estimada de cierre</div><div class="v">${formatDate(r.cierre)}</div>
            <div class="k">Estación</div><div class="v">${r.estacion}</div>
            <div class="k">Responsable</div><div class="v">${r.responsablePrincipal}</div>
            <div class="k">Responsable de seguimiento</div><div class="v">${r.responsable}</div>
          </div></div></section>
        <section class="card"><div class="hd">Descripción del reporte</div><div class="bd">${segmentParagraphs(r.descripcion).map(p=>`<p>${p}</p>`).join('')}</div></section>
      </div>
      <div class="grid">
        <section class="card"><div class="hd">Plan de acción</div><div class="bd"><ul class="plan-accion">${acciones}</ul></div></section>
        <section class="card"><div class="hd">Notas de actualización</div><div class="bd"><ul class="timeline">${updates}</ul></div></section>
      </div>
      ${evidenciasHTML}
      ${pruebasHTML}`;
      el.classList.add('active');
    }

    async function fetchReport(id){
      const url=`${FN_URL}?id=${encodeURIComponent(id)}`;
      try{
        const resp=await fetch(url,{headers:{'Accept':'application/json'}});
        const text=await resp.text();
        if(!resp.ok){ui.show(`❌ Error ${resp.status}<br>${text}`);return;}
        const data=JSON.parse(text),f=data.fields||{};
        const acciones=f["Plan de acción propuesto"]?[f["Plan de acción propuesto"]]:[];
        const updates=f["Notas de actualización"]?[{texto:f["Notas de actualización"]}]:[];
        const pruebas=Array.isArray(f["Pruebas de cierre"])?f["Pruebas de cierre"].map(a=>({url:a.url,filename:a.filename})):[];

        const evidencias=Array.isArray(f["Evidencias"])
          ? f["Evidencias"].map(a=>({url:a.url,filename:a.filename,type:a.type}))
          : [];

        return{
          id:f["ID del reporte"]||id,
          fecha:f["Fecha de Evento"]||"",
          cierre:f["Fecha estimada de cierre"]||"",
          cierreEfectivo:f["Fecha real de cierre"]||"",
          estado:f["Estado del reporte"]||"—",
          responsablePrincipal:f["Responsable"]||"",
          responsable:f["Responsable del seguimiento"]||"",
          estacion:f["Estación"]||"",
          descripcion:f["Descripción del Suceso"]||"",
          acciones,updates,pruebas,evidencias
        };
      }catch(e){ui.show(`❌ ${e.message}`);}
    }

    document.addEventListener('DOMContentLoaded',()=>{
      const form=$('#searchForm'),input=$('#reportId'),btn=$('#btnBuscar');
      form.addEventListener('submit',async e=>{
        e.preventDefault();
        const id=(input.value||'').trim().toUpperCase();
        if(!id){ui.show('Escribe el ID del reporte.');return;}
        if(!ID_REGEX.test(id)){ui.show('Formato inválido.');return;}
        btn.disabled=true;btn
