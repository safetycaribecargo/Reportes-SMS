<!DOCTYPE html>
</div>
</div>
</section>


<section class="card">
<div class="hd">Descripción del reporte</div>
<div class="bd">${
segmentParagraphs(r.descripcion).map(p => `<p style="margin-bottom:12px; line-height:1.6">${p}</p>`).join('') || "<em>—</em>"
}</div>
</section>
</div>


<div class="grid">
<section class="card">
<div class="hd">Plan de acción</div>
<div class="bd"><ul class="plan-accion">${acciones}</ul></div>
</section>
<section class="card">
<div class="hd">Notas de actualización</div>
<div class="bd"><ul class="timeline">${updates}</ul></div>
</section>
</div>


${evidenciasHTML}
${pruebasHTML}
`;
el.classList.add('active');
}


async function fetchReport(id){
const url = `${FN_URL}?id=${encodeURIComponent(id)}`;
let resp, text;
try{
resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
text = await resp.text();
}catch(err){ ui.show(`❌ No se pudo conectar con el servidor.<br><small>${err.message}</small>`); return null; }
if(!resp.ok){ ui.show(`❌ Error ${resp.status} en la función.<br><small>${text}</small>`); return null; }


let data; try{ data = JSON.parse(text); } catch(err){ ui.show(`❌ Respuesta inválida del servidor (JSON).`); return null; }
const f = data.fields || {};


const acciones = Array.isArray(f["Plan de acción propuesto"]) ? f["Plan de acción propuesto"]
: f["Plan de acción propuesto"] ? segmentParagraphs(String(f["Plan de acción propuesto"]))
: Array.isArray(f["Acciones tomadas"]) ? f["Acciones tomadas"]
: f["Acciones tomadas"] ? segmentParagraphs(String(f["Acciones tomadas"]))
: [];


let updates = [];
const updRaw = f["Notas de actualización"] ?? f["Notas"];
if (Array.isArray(updRaw)) { updates = updRaw.flatMap(t => segmentParagraphs(String(t)).map(p => ({ texto: p, fecha: "" }))); }
else if (updRaw) { updates = segmentParagraphs(String(updRaw)).map(p => ({ texto: p, fecha: "" })); }


const cierreRaw = f["Fecha estimada de cierre (vigente)"] ?? f["Fecha estimada de cierre"] ?? f["Fecha Estimada de Cierre"] ?? "";
const cierre = (cierreRaw && typeof cierreRaw === "object") ? (cierreRaw.start || cierreRaw.date || "") : cierreRaw;


const cierreRealRaw = f["Fecha real de cierre"] ?? f["Fecha Real de Cierre"] ?? f["Fecha de cierre real"] ?? f["Fecha de cierre efectiva"] ?? f["Fecha de Cierre Efectiva"] ?? f["Fecha de cierre"] ?? f["Fecha de Cierre"] ?? "";
const cierreEfectivo = (cierreRealRaw && typeof cierreRealRaw === "object") ? (cierreRealRaw.start || cierreRealRaw.date || "") : cierreRealRaw;


const responsablePrincipal = f["Responsable"] || f["Responsable principal"] || (Array.isArray(f["Responsable (lookup)"]) ? f["Responsable (lookup)"][0] : f["Responsable (lookup)"]) || "";
const responsableSeg = f["Responsable del seguimiento"] || f["Responsable seguimiento"] || (Array.isArray(f["Responsable de seguimiento (lookup)"]) ? f["Responsable de seguimiento (lookup)"][0] : f["Responsable de seguimiento (lookup)"]) || "";


const descripcion = f["Descripción del Suceso"] || f["Descripción del suceso"] || f["Descripcion del Suceso"] || f["Descripción"] || f["Descripcion"] || "";
const estacion = f["Estación"] || f["Estación/Área"] || "";


// ===== Attachments =====
const pruebas = Array.isArray(f["Pruebas de cierre"]) ? f["Pruebas de cierre"].map(a => ({ url: a.url || a?.thumbnails?.large?.url || a?.thumbnails?.full?.url || "", filename: a.filename || "Prueba de cierre", type: a.type || '' })).filter(x => x.url) : [];


const evidencias = Array.isArray(f["Evidencias"]) ? f["Evidencias"].map(a => ({ url: a.url || a?.thumbnails?.large?.url || a?.thumbnails?.full?.url || "", filename: a.filename || "Evidencia", type: a.type || '' })).filter(x => x.url) : [];


return {
id: f["ID del reporte"] || id,
fecha: f["Fecha de Evento"] || f["Fecha"] || "",
cierre,
cierreEfectivo,
estado: f["Estado del reporte"] || f["Estado"] || "—",
responsablePrincipal,
responsable: responsableSeg,
estacion,
descripcion,
acciones,
updates,
</html>
